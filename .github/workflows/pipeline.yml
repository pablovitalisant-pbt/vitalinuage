name: Deployment Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcairo2 \
            libpango-1.0-0 \
            libgobject-2.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf-2.0-0 \
            libffi-dev \
            shared-mime-info

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest httpx
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

      - name: Lint with Flake8
        run: |
          python -m flake8 backend --count --select=E9,F63,F7,F82 --show-source --statistics
          python -m flake8 backend --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Clear npm cache (force fresh build)
        working-directory: ./frontend
        run: |
          echo "Limpiando cach√© para forzar build fresco..."
          rm -rf node_modules/.vite
          rm -rf dist
          
          echo "CR√çTICO: Eliminando archivos .env que interfieren con secretos de GitHub..."
          rm -f .env .env.local .env.production .env.development
          echo "‚úÖ Limpieza completada - Todos los .env eliminados"

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: DEBUG - Dump ALL Environment Variables
        working-directory: ./frontend
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_API_URL: ${{ secrets.FRONTEND_URL }}
        run: |
          echo "=== DUMP COMPLETO DE VARIABLES ==="
          echo "Nota: Mostrando solo primeros caracteres por seguridad"
          echo ""
          env | grep VITE_ | while IFS='=' read -r name value; do
            if [ -n "$value" ]; then
              echo "‚úÖ $name = ${value:0:15}... (${#value} chars)"
            else
              echo "‚ùå $name = (VAC√çO o NO DEFINIDO)"
            fi
          done
          echo ""
          
          # Test cr√≠tico: ¬øAlguna variable est√° vac√≠a?
          EMPTY_VARS=0
          for var in VITE_FIREBASE_API_KEY VITE_FIREBASE_AUTH_DOMAIN VITE_FIREBASE_PROJECT_ID VITE_FIREBASE_STORAGE_BUCKET VITE_FIREBASE_MESSAGING_SENDER_ID VITE_FIREBASE_APP_ID; do
            eval val=\$var
            if [ -z "$val" ]; then
              echo "‚ùå‚ùå‚ùå CR√çTICO: $var est√° VAC√çA"
              EMPTY_VARS=$((EMPTY_VARS + 1))
            fi
          done
          
          if [ $EMPTY_VARS -gt 0 ]; then
            echo ""
            echo "üö®üö®üö® FALL√ì: $EMPTY_VARS variables est√°n vac√≠as"
            echo "Esto significa que GitHub NO est√° pasando los secretos correctamente"
            echo ""
            echo "POSIBLES CAUSAS:"
            echo "1. Los secretos tienen valores vac√≠os en GitHub"
            echo "2. Los secretos est√°n en 'Environments' y este job no tiene acceso"
            echo "3. Hay un problema de permisos en el repositorio"
            exit 1
          fi
          
          echo "‚úÖ‚úÖ‚úÖ TODAS las variables tienen valores"

      - name: Build Frontend con Secretos
        working-directory: ./frontend
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_API_URL: ${{ secrets.FRONTEND_URL }}
        run: npm run build

      - name: Verify Build Output (Debug)
        working-directory: ./frontend
        run: |
          echo "=== Verificando que dist/ tiene contenido ==="
          ls -lah dist/
          echo ""
          
          echo "=== B√öSQUEDA DE VALORES REALES DE FIREBASE ==="
          echo "Si Vite proces√≥ correctamente las variables, deber√≠amos ver valores reales aqu√≠"
          echo ""
          
          echo "1. Buscando 'AIzaSy' (prefijo de Firebase API keys):"
          if grep -r "AIzaSy" dist/assets/*.js 2>/dev/null; then
            echo "‚úÖ Se encontr√≥ API key real"
          else
            echo "‚ùå NO se encontr√≥ - las variables NO fueron inyectadas"
            exit 1
          fi
          echo ""
          
          echo "2. Buscando '.firebaseapp.com' (auth domain):"
          if grep -r "firebaseapp\.com" dist/assets/*.js 2>/dev/null; then
            echo "‚úÖ Se encontr√≥ auth domain real"
          else
            echo "‚ùå NO se encontr√≥ - las variables NO fueron inyectadas"
            exit 1
          fi
          echo ""
          
          echo "3. Verificando que NO hay valores literalmente vac√≠os en firebaseConfig:"
          if grep -E 'apiKey:""|authDomain:""' dist/assets/*.js 2>/dev/null; then
            echo "‚ùå‚ùå‚ùå CR√çTICO: Encontrados valores vac√≠os en la configuraci√≥n"
            exit 1
          else
            echo "‚úÖ No hay valores vac√≠os en la configuraci√≥n"
          fi
          echo ""
          
          echo "‚úÖ‚úÖ‚úÖ BUILD EXITOSO - Todas las verificaciones pasaron"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

  build:
    needs: [quality, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create frontend directory structure
        run: mkdir -p frontend/dist

      - name: Download frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Verify Download Success
        run: |
          echo "=== Verificando descarga del artefacto ==="
          pwd
          ls -lah
          echo ""
          echo "=== ¬øExiste frontend/? ==="
          ls -lah frontend/ || echo "No existe directorio frontend"
          echo ""
          echo "=== ¬øExiste frontend/dist/? ==="
          ls -lah frontend/dist/ || echo "No existe directorio frontend/dist"
          echo ""
          if [ ! -d "frontend/dist" ] || [ -z "$(ls -A frontend/dist)" ]; then
            echo "ERROR CR√çTICO: frontend/dist no existe o est√° vac√≠o"
            exit 1
          fi
          echo "‚úÖ frontend/dist existe y tiene contenido"

      - name: Verify frontend/dist Content
        run: |
          echo "=== Estructura del proyecto ==="
          ls -lah
          echo ""
          echo "=== Verificando que existe frontend/dist ==="
          if [ ! -d "frontend/dist" ]; then
            echo "ERROR: frontend/dist no existe!"
            exit 1
          fi
          echo "=== Contenido de frontend/dist ==="
          ls -lah frontend/dist
          echo ""
          echo "=== Archivos en frontend/dist/assets ==="
          ls -lah frontend/dist/assets/ || echo "No hay carpeta assets"
          echo ""
          echo "=== Verificando apiKey en JS descargado ==="
          grep -r "apiKey" frontend/dist/assets/*.js | head -n 3 || echo "ADVERTENCIA: No se encontr√≥ apiKey"

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Docker Auth
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Container
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then echo "ERROR: GCP_PROJECT_ID empty"; exit 1; fi
          if [ -z "${{ secrets.GCP_REPOSITORY }}" ]; then echo "ERROR: GCP_REPOSITORY empty"; exit 1; fi

          IMAGE_TAG="us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/vitalinuage-backend:${{ github.sha }}"

          echo "=== Verificaci√≥n final antes de docker build ==="
          echo "Directorio actual: $(pwd)"
          echo "Contenido de frontend/dist:"
          ls -lah frontend/dist
          echo ""
          
          # CR√çTICO: El contexto de build (.) incluye frontend/dist con los secretos
          docker build \
            -t "$IMAGE_TAG" \
            -f backend/Dockerfile .

          docker push "$IMAGE_TAG"

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: vitalinuage-backend
          region: us-central1
          image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/vitalinuage-backend:${{ github.sha }}
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}