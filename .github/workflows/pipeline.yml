name: Deployment Pipeline

on:
  push:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest httpx
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          
      - name: Lint
        run: |
          flake8 backend --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 backend --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          
      - name: Test
        run: |
          export PYTHONPATH=$PYTHONPATH:backend
          pytest backend/tests

  build-and-deploy:
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
            credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Docker Auth'
        run: |-
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: 'Build and Push Container'
        run: |-
          docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/vitalinuage/backend:${{ github.sha }} ./backend
          docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/vitalinuage/backend:${{ github.sha }}

      - name: 'Deploy to Cloud Run'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'vitalinuage-backend'
          image: 'us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/vitalinuage/backend:${{ github.sha }}'
          region: 'us-central1'
          env_vars: |
            DATABASE_URL=${{ secrets.NEON_DATABASE_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            SECRET_KEY=${{ secrets.APP_SECRET_KEY }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}

  smoke-test:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      
      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c
        with:
          python-version: '3.10'
          
      - name: Install Test Deps
        run: pip install requests pytest
        
      - name: Run Smoke Test
        env:
          PROD_API_URL: ${{ secrets.PROD_API_URL }}
        run: |
          pytest backend/tests/smoke_test_prod.py
