
> vitalinuage-frontend@0.0.0 test
> jest ConsultationManager.dispatch.test.tsx

FAIL src/components/ConsultationManager.dispatch.test.tsx
  ConsultationManager - Dispatch Tracking (Slice 07.3)
    ├ù should fetch dispatch status on load (75 ms)
    ├ù should display email sent badge when status confirms it (1062 ms)
    ├ù should call mark-whatsapp-sent when WhatsApp button is clicked (1056 ms)

  ÔùÅ ConsultationManager - Dispatch Tracking (Slice 07.3) ÔÇ║ should fetch dispatch status on load

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "/api/consultas/1/dispatch-status", Anything
    Received: "/api/pacientes/1/consultas", {"headers": {"Authorization": "Bearer test-token"}}

    Number of calls: 1

      94 |         // Verify fetch was called for dispatch status
      95 |         // This will fail because implementation doesn't call it yet
    > 96 |         expect(global.fetch).toHaveBeenCalledWith(
         |                              ^
      97 |             expect.stringContaining('/api/consultas/1/dispatch-status'),
      98 |             expect.anything()
      99 |         );

      at Object.<anonymous> (src/components/ConsultationManager.dispatch.test.tsx:96:30)

  ÔùÅ ConsultationManager - Dispatch Tracking (Slice 07.3) ÔÇ║ should display email sent badge when status confirms it

    Unable to find an element with the title: /Enviado por Email el/i.

    Ignored nodes: comments, script, style
    <body>
      <div>
        <div
          class="bg-white rounded-xl shadow-sm border border-slate-100 p-6"
        >
          <div
            class="flex justify-between items-center mb-6"
          >
            <div
              class="flex items-center gap-2"
            >
              <svg
                class="lucide lucide-activity text-[#1e3a8a] w-5 h-5"
                fill="none"
                height="24"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                viewBox="0 0 24 24"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M22 12h-4l-3 9L9 3l-3 9H2"
                />
              </svg>
              <h2
                class="text-lg font-semibold text-[#1e3a8a]"
              >
                Evoluci├â┬│n Cl├â┬¡nica
              </h2>
            </div>
            <button
              class="flex items-center gap-2 bg-[#1e3a8a] text-white px-4 py-2 rounded-lg hover:bg-blue-900 transition-colors text-sm font-medium shadow-sm"
            >
              <svg
                class="lucide lucide-plus w-4 h-4"
                fill="none"
                height="24"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                viewBox="0 0 24 24"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M5 12h14"
                />
                <path
                  d="M12 5v14"
                />
              </svg>
              Nueva Consulta
            </button>
          </div>
          <div
            class="space-y-4"
          >
            <div
              class="group border border-slate-100 rounded-lg p-5 hover:shadow-md transition-all bg-white relative"
            >
              <div
                class="absolute top-5 right-5 flex items-center gap-3"
              >
                <button
                  class="flex items-center gap-1 px-3 py-1.5 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors text-xs font-medium shadow-sm"
                  title="Enviar por WhatsApp"
                >
                  <svg
                    class="lucide lucide-message-circle w-3.5 h-3.5"
                    fill="none"
                    height="24"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"
                    />
                  </svg>
                  WhatsApp
                </button>
                <button
                  class="flex items-center gap-1 px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors text-xs font-medium shadow-sm"
                  title="Enviar por Email"
                >
                  <svg
                    class="lucide lucide-mail w-3.5 h-3.5"
                    fill="none"
                    height="24"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <rect
                      height="16"
                      rx="2"
                      width="20"
                      x="2"
                      y="4"
                    />
                    <path
                      d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"
                    />
                  </svg>
                  Email
                </button>
                <button
                  class="flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-xs font-medium shadow-sm"
                  title="Descargar Receta PDF"
                >
                  <svg
                    class="lucide lucide-file-text w-3.5 h-3.5"
                    fill="none"
                    height="24"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                    />
                    <polyline
                      points="14 2 14 8 20 8"
                    />
                    <line
                      x1="16"
                      x2="8"
                      y1="13"
                      y2="13"
                    />
                    <line
                      x1="16"
                      x2="8"
                      y1="17"
                      y2="17"
                    />
                    <line
                      x1="10"
                      x2="8"
                      y1="9"
                      y2="9"
                    />
                  </svg>
                  Receta PDF
                </button>
                <div
                  class="text-xs text-slate-400 flex items-center gap-1"
                >
                  <svg
                    class="lucide lucide-calendar w-3 h-3"
                    fill="none"
                    height="24"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <rect
                      height="18"
                      rx="2"
                      ry="2"
                      width="18"
                      x="3"
                      y="4"
                    />
                    <line
                      x1="16"
                      x2="16"
                      y1="2"
                      y2="6"
                    />
                    <line
                      x1="8"
                      x2="8"
                      y1="2"
                      y2="6"
                    />
                    <line
                      x1="3"
                      x2="21"
                      y1="10"
                      y2="10"
                    />
                  </svg>
                  Fecha desc.
                </div>
              </div>
              <h3
                class="text-md font-semibold text-[#1e3a8a] mb-1"
              />
              <p
                class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3"
              >
                DX: 
              </p>
              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600"
              >
                <div
                  class="bg-slate-50 p-3 rounded border border-slate-100"
                >
                  <p
                    class="font-semibold text-xs text-slate-400 mb-1"
                  >
                    TRATAMIENTO
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </body>

      128 |         // Adjust text regex to whatever UI visual cue we decide on. E.g. "Enviado"
      129 |         // This will fail
    > 130 |         expect(await screen.findByTitle(/Enviado por Email el/i)).toBeInTheDocument();
          |                             ^
      131 |     });
      132 |
      133 |     it('should call mark-whatsapp-sent when WhatsApp button is clicked', async () => {

      at waitForWrapper (node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (src/components/ConsultationManager.dispatch.test.tsx:130:29)

  ÔùÅ ConsultationManager - Dispatch Tracking (Slice 07.3) ÔÇ║ should call mark-whatsapp-sent when WhatsApp button is clicked

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "/api/consultas/1/mark-whatsapp-sent", ObjectContaining {"method": "POST"}
    Received
           1: "/api/pacientes/1/consultas", {"headers": {"Authorization": "Bearer test-token"}}
           2: "http://test-api/api/consultas/1/create-verification", {"headers": {"Authorization": "Bearer test-token"}, "method": "POST"}

    Number of calls: 2

    Ignored nodes: comments, script, style
    <html>
      <head />
      <body>
        <div>
          <div
            class="bg-white rounded-xl shadow-sm border border-slate-100 p-6"
          >
            <div
              class="flex justify-between items-center mb-6"
            >
              <div
                class="flex items-center gap-2"
              >
                <svg
                  class="lucide lucide-activity text-[#1e3a8a] w-5 h-5"
                  fill="none"
                  height="24"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  width="24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M22 12h-4l-3 9L9 3l-3 9H2"
                  />
                </svg>
                <h2
                  class="text-lg font-semibold text-[#1e3a8a]"
                >
                  Evoluci├â┬│n Cl├â┬¡nica
                </h2>
              </div>
              <button
                class="flex items-center gap-2 bg-[#1e3a8a] text-white px-4 py-2 rounded-lg hover:bg-blue-900 transition-colors text-sm font-medium shadow-sm"
              >
                <svg
                  class="lucide lucide-plus w-4 h-4"
                  fill="none"
                  height="24"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  width="24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M5 12h14"
                  />
                  <path
                    d="M12 5v14"
                  />
                </svg>
                Nueva Consulta
              </button>
            </div>
            <div
              class="space-y-4"
            >
              <div
                class="group border border-slate-100 rounded-lg p-5 hover:shadow-md transition-all bg-white relative"
              >
                <div
                  class="absolute top-5 right-5 flex items-center gap-3"
                >
                  <button
                    class="flex items-center gap-1 px-3 py-1.5 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors text-xs font-medium shadow-sm"
                    title="Enviar por WhatsApp"
                  >
                    <svg
                      class="lucide lucide-message-circle w-3.5 h-3.5"
                      fill="none"
                      height="24"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                      width="24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"
                      />
                    </svg>
                    WhatsApp
                  </button>
                  <button
                    class="flex items-center gap-1 px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors text-xs font-medium shadow-sm"
                    title="Enviar por Email"
                  >
                    <svg
                      class="lucide lucide-mail w-3.5 h-3.5"
                      fill="none"
                      height="24"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                      width="24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <rect
                        height="16"
                        rx="2"
                        width="20"
                        x="2"
                        y="4"
                      />
                      <path
                        d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"
                      />
                    </svg>
                    Email
                  </button>
                  <button
                    class="flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-xs font-medium shadow-sm"
                    title="Descargar Receta PDF"
                  >
                    <svg
                      class="lucide lucide-file-text w-3.5 h-3.5"
                      fill="none"
                      height="24"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                      width="24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                      />
                      <polyline
                        points="14 2 14 8 20 8"
                      />
                      <line
                        x1="16"
                        x2="8"
                        y1="13"
                        y2="13"
                      />
                      <line
                        x1="16"
                        x2="8"
                        y1="17"
                        y2="17"
                      />
                      <line
                        x1="10"
                        x2="8"
                        y1="9"
                        y2="9"
                      />
                    </svg>
                    Receta PDF
                  </button>
                  <div
                    class="text-xs text-slate-400 flex items-center gap-1"
                  >
                    <svg
                      class="lucide lucide-calendar w-3 h-3"
                      fill="none"
                      height="24"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                      width="24"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <rect
                        height="18"
                        rx="2"
                        ry="2"
                        width="18"
                        x="3"
                        y="4"
                      />
                      <line
                        x1="16"
                        x2="16"
                        y1="2"
                        y2="6"
                      />
                      <line
                        x1="8"
                        x2="8"
                        y1="2"
                        y2="6"
                      />
                      <line
                        x1="3"
                        x2="21"
                        y1="10"
                        y2="10"
                      />
                    </svg>
                    04-01-2026
                  </div>
                </div>
                <h3
                  class="text-md font-semibold text-[#1e3a8a] mb-1"
                >
                  Test tracking
                </h3>
                <p
                  class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3"
                >
                  DX: 
                  Flu
                </p>
                <div
                  class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600"
                >
                  <div
                    class="bg-slate-50 p-3 rounded border border-slate-100"
                  >
                    <p
                      class="font-semibold text-xs text-slate-400 mb-1"
                    >
                      TRATAMIENTO
                    </p>
                    Rest
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </body>
    </html>

      143 |         await waitFor(() => {
      144 |             // This will fail because we haven't added this call yet
    > 145 |             expect(global.fetch).toHaveBeenCalledWith(
          |                                  ^
      146 |                 expect.stringContaining('/api/consultas/1/mark-whatsapp-sent'),
      147 |                 expect.objectContaining({ method: 'POST' })
      148 |             );

      at src/components/ConsultationManager.dispatch.test.tsx:145:34
      at runWithExpensiveErrorDiagnosticsDisabled (node_modules/@testing-library/dom/dist/config.js:47:12)
      at checkCallback (node_modules/@testing-library/dom/dist/wait-for.js:124:77)
      at checkRealTimersCallback (node_modules/@testing-library/dom/dist/wait-for.js:118:16)
      at Timeout.task [as _onTimeout] (node_modules/jsdom/lib/jsdom/browser/Window.js:579:19)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 3 total
Snapshots:   0 total
Time:        3.6 s
Ran all test suites matching ConsultationManager.dispatch.test.tsx.
