# Especificación: Envío de Receta por WhatsApp (Slice 07.1)

## 1. Contexto y Objetivo

### Estado Actual
- **Slice 06.4**: Sistema QR genera UUID único por receta
- **Tabla**: `prescription_verifications` con UUID, consultation_id, doctor_name
- **Problema**: Médico debe enviar manualmente la receta al paciente

### Objetivo del Slice 07.1
Permitir al médico enviar la receta al paciente vía WhatsApp con un solo clic:
1. Generar link público al PDF de la receta
2. Detectar dispositivo (Mobile vs Desktop)
3. Abrir WhatsApp con mensaje pre-formateado
4. Enviar link de descarga directa del PDF

## 2. Arquitectura del Sistema

### 2.1 Flujo de Datos

```
Médico click "Enviar WhatsApp" → Detectar dispositivo
                                        ↓
                                  Mobile o Desktop?
                                        ↓
                    ┌───────────────────┴───────────────────┐
                    │                                       │
                 Mobile                                  Desktop
                    │                                       │
                    ▼                                       ▼
         Abrir wa.me directamente              Mostrar Toast de aviso
                    │                                       │
                    └───────────────────┬───────────────────┘
                                        ▼
                    WhatsApp con mensaje pre-formateado
                                        ▼
                    Link: /api/v/{uuid}/pdf (público)
```

## 3. Endpoint Público de PDF

### 3.1 Especificación del Endpoint

```python
# backend/api/verification.py (MODIFICAR)

@router.get("/{verification_uuid}/pdf")
async def download_prescription_pdf(
    verification_uuid: str,
    db: Session = Depends(get_db)
):
    """
    Endpoint público para descargar PDF de receta verificada.
    
    - **verification_uuid**: UUID de la verificación
    - **Sin autenticación**: Accesible para pacientes
    
    Returns:
        PDF file (application/pdf)
    
    Raises:
        404: Receta no encontrada
    """
    # 1. Buscar verificación
    verification = db.query(models.PrescriptionVerification).filter(
        models.PrescriptionVerification.uuid == verification_uuid
    ).first()
    
    if not verification:
        raise HTTPException(status_code=404, detail="Receta no encontrada")
    
    # 2. Obtener consulta
    consultation = db.query(models.ClinicalConsultation).filter(
        models.ClinicalConsultation.id == verification.consultation_id
    ).first()
    
    if not consultation:
        raise HTTPException(status_code=404, detail="Consulta no encontrada")
    
    # 3. Obtener mapa del médico
    prescription_map = db.query(models.PrescriptionMap).filter(
        models.PrescriptionMap.doctor_id == verification.doctor_email,
        models.PrescriptionMap.is_active == True
    ).first()
    
    # 4. Generar PDF
    from services.pdf_service import PDFService
    
    if prescription_map:
        # Con coordenadas personalizadas
        import tempfile
        with tempfile.NamedTemporaryFile(suffix='.pdf', delete=False) as tmp:
            pdf_bytes = PDFService.generate_with_coordinates(
                consultation, 
                prescription_map, 
                tmp.name,
                db=db
            )
    else:
        # Template estándar
        pdf_bytes = PDFService.generate_with_template(consultation)
    
    # 5. Incrementar contador de descargas (opcional)
    verification.scanned_count += 1
    db.commit()
    
    # 6. Retornar PDF
    return Response(
        content=pdf_bytes,
        media_type="application/pdf",
        headers={
            "Content-Disposition": f"inline; filename=receta_{verification.doctor_name.replace(' ', '_')}.pdf"
        }
    )
```

### 3.2 URL Pública

**Formato:**
```
https://vitalinuage.com/api/v/{uuid}/pdf
```

**Ejemplo:**
```
https://vitalinuage.com/api/v/a3f5c8d2-4b7e-4a1c-9d3f-8e2b5c7a9f1d/pdf
```

## 4. Detección de Dispositivo (Frontend)

### 4.1 Función de Detección

```typescript
// frontend/src/utils/device.ts (NUEVO)

export const isMobileDevice = (): boolean => {
    // Detectar por User Agent
    const userAgent = navigator.userAgent || navigator.vendor || (window as any).opera;
    
    // Detectar móviles comunes
    const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
    
    return mobileRegex.test(userAgent);
};

export const isDesktopDevice = (): boolean => {
    return !isMobileDevice();
};
```

### 4.2 Lógica de Envío WhatsApp

```typescript
// frontend/src/components/ConsultationManager.tsx (MODIFICAR)

const handleSendWhatsApp = (consultation: ClinicalConsultation) => {
    // 1. Obtener UUID de verificación (debe estar en consultation o hacer fetch)
    const verificationUuid = consultation.verification_uuid; // Asumiendo que existe
    
    if (!verificationUuid) {
        alert('Esta receta no tiene código de verificación. Genere el PDF primero.');
        return;
    }
    
    // 2. Construir URL pública del PDF
    const apiUrl = import.meta.env.VITE_API_URL || 'https://vitalinuage.com';
    const pdfUrl = `${apiUrl}/api/v/${verificationUuid}/pdf`;
    
    // 3. Obtener datos del paciente
    const patientName = `${consultation.patient.nombre} ${consultation.patient.apellido_paterno}`;
    const doctorName = "Dr. Vitalinuage"; // TODO: Get from context
    
    // 4. Construir mensaje
    const message = `Hola ${patientName}, el ${doctorName} le envía su receta médica de Vitalinuage. Puede verla aquí: ${pdfUrl}`;
    
    // 5. Codificar mensaje para URL
    const encodedMessage = encodeURIComponent(message);
    
    // 6. Obtener teléfono del paciente
    const phone = consultation.patient.telefono?.replace(/\D/g, ''); // Solo dígitos
    
    if (!phone) {
        alert('El paciente no tiene teléfono registrado.');
        return;
    }
    
    // 7. Construir URL de WhatsApp
    const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    
    // 8. Detectar dispositivo y actuar
    if (isMobileDevice()) {
        // Mobile: Abrir directamente
        window.open(whatsappUrl, '_blank');
    } else {
        // Desktop: Mostrar aviso primero
        toast.info('Asegúrate de tener WhatsApp Web abierto en otra pestaña', {
            duration: 3000,
        });
        
        // Esperar 1 segundo y abrir
        setTimeout(() => {
            window.open(whatsappUrl, '_blank');
        }, 1000);
    }
};
```

## 5. Integración en ConsultationManager

### 5.1 Botón de WhatsApp

```typescript
// Añadir junto al botón "Receta PDF"
<button
    onClick={() => handleSendWhatsApp(c)}
    className="flex items-center gap-1 px-3 py-1.5 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors text-xs font-medium shadow-sm"
    title="Enviar por WhatsApp"
>
    <MessageCircle className="w-3.5 h-3.5" />
    WhatsApp
</button>
```

### 5.2 Icono de WhatsApp

```typescript
// Importar de lucide-react
import { MessageCircle } from 'lucide-react';
```

## 6. Plantilla de Mensaje

### 6.1 Formato del Mensaje

```
Hola [Nombre Paciente], el [Nombre Médico] le envía su receta médica de Vitalinuage. Puede verla aquí: [Link_PDF_Público]
```

### 6.2 Ejemplo Real

```
Hola Juan Pérez, el Dr. Carlos Rodríguez le envía su receta médica de Vitalinuage. Puede verla aquí: https://vitalinuage.com/api/v/a3f5c8d2-4b7e-4a1c-9d3f-8e2b5c7a9f1d/pdf
```

### 6.3 Consideraciones

- **Longitud**: Máximo 1000 caracteres (límite WhatsApp)
- **Encoding**: URL encode para caracteres especiales
- **Personalización**: Usar nombre real del médico y paciente
- **Link**: Siempre HTTPS para seguridad

## 7. Problema: UUID No Disponible en Consulta

### 7.1 Análisis

Actualmente, el UUID de verificación se genera **solo cuando se crea el PDF con QR**.

**Opciones:**

#### Opción A: Generar UUID al crear consulta
- **Pros**: UUID siempre disponible
- **Contras**: Genera UUIDs innecesarios si nunca se imprime

#### Opción B: Generar UUID al hacer clic en "Enviar WhatsApp"
- **Pros**: Solo genera si se necesita
- **Contras**: Requiere llamada al backend antes de abrir WhatsApp

#### Opción C: Reutilizar UUID del QR (si existe)
- **Pros**: No duplica UUIDs
- **Contras**: Requiere verificar si ya existe

### 7.2 Solución Propuesta: **Opción B**

**Flujo:**
1. Usuario click "Enviar WhatsApp"
2. Frontend verifica si consultation tiene `verification_uuid`
3. Si NO existe:
   - Llamar `POST /api/consultas/{id}/create-verification`
   - Retorna `{ uuid: "..." }`
   - Guardar en estado local
4. Construir mensaje con UUID
5. Abrir WhatsApp

**Endpoint Nuevo:**
```python
@router.post("/{consultation_id}/create-verification")
async def create_verification(
    consultation_id: int,
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """
    Crea un registro de verificación para una consulta.
    Reutiliza si ya existe.
    """
    # Verificar autorización
    consultation = db.query(models.ClinicalConsultation).filter(
        models.ClinicalConsultation.id == consultation_id,
        models.ClinicalConsultation.owner_id == current_user.email
    ).first()
    
    if not consultation:
        raise HTTPException(404, "Consultation not found")
    
    # Buscar verificación existente
    verification = db.query(models.PrescriptionVerification).filter(
        models.PrescriptionVerification.consultation_id == consultation_id
    ).first()
    
    if verification:
        return {"uuid": verification.uuid}
    
    # Crear nueva
    import uuid as uuid_lib
    import datetime
    
    verification = models.PrescriptionVerification(
        uuid=str(uuid_lib.uuid4()),
        consultation_id=consultation_id,
        doctor_email=current_user.email,
        doctor_name=current_user.professional_name or "Dr. Vitalinuage",
        issue_date=datetime.datetime.utcnow()
    )
    db.add(verification)
    db.commit()
    
    return {"uuid": verification.uuid}
```

## 8. Criterios de Aceptación

### 8.1 Backend
- [ ] Endpoint `GET /api/v/{uuid}/pdf` funcional (público)
- [ ] Endpoint `POST /api/consultas/{id}/create-verification` funcional
- [ ] PDF se descarga correctamente sin autenticación
- [ ] Contador de descargas se incrementa

### 8.2 Frontend
- [ ] Botón "WhatsApp" visible en cada consulta
- [ ] Detección de dispositivo funciona
- [ ] Mobile: Abre WhatsApp directamente
- [ ] Desktop: Muestra toast de aviso
- [ ] Mensaje incluye nombre paciente, médico y link
- [ ] Link funciona y descarga PDF

### 8.3 UX
- [ ] Toast informativo en desktop
- [ ] Manejo de error si paciente no tiene teléfono
- [ ] Manejo de error si no hay UUID

## 9. FILES-TO-TOUCH (Fase C)

```
backend/api/verification.py                    # MODIFICAR: Añadir GET /{uuid}/pdf
backend/api/consultations.py                   # MODIFICAR: Añadir POST /{id}/create-verification
frontend/src/utils/device.ts                   # NUEVO: Detección de dispositivo
frontend/src/components/ConsultationManager.tsx # MODIFICAR: Botón WhatsApp
```

## 10. Dependencias

### 10.1 Frontend
```json
// Ya instalado
"lucide-react": "^0.x.x"  // Para icono MessageCircle
"react-hot-toast": "^2.x.x"  // Para toast de aviso
```

### 10.2 Backend
No requiere dependencias adicionales.

## 11. Feature Flag

```json
// config/feature-flags.json
{
    "prescription_coords_v1": true,
    "qr_verification_v1": true,
    "whatsapp_sharing_v1": false  // NUEVO: Inicialmente desactivado
}
```

## 12. Estimación

- **Backend (Endpoints)**: 1.5 horas
- **Frontend (Botón + Lógica)**: 1.5 horas
- **Tests**: 1 hora
- **Total**: **4 horas**

## 13. Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigación |
|--------|--------------|---------|------------|
| Paciente sin teléfono | Alta | Medio | Validar y mostrar error claro |
| WhatsApp Web no abierto (Desktop) | Media | Bajo | Toast de aviso preventivo |
| Link muy largo para WhatsApp | Baja | Bajo | URL corta (UUID 36 chars) |
| PDF no se genera correctamente | Baja | Alto | Reutilizar lógica existente probada |

## 14. Seguridad

### 14.1 Consideraciones
- ✅ **Endpoint público**: Necesario para que paciente descargue
- ✅ **UUID impredecible**: UUID v4 (128 bits de entropía)
- ✅ **Sin datos sensibles en URL**: Solo UUID
- ⚠️ **Cualquiera con link puede descargar**: Aceptable (similar a QR)

### 14.2 Protección Adicional
- **Rate Limiting**: Máximo 10 descargas por minuto por IP
- **Logging**: Registrar todas las descargas con IP y timestamp
- **Expiración (futuro)**: Invalidar link después de 30 días

## 15. Próximos Pasos (Post-Slice 07.1)

- **Slice 07.2**: Historial de envíos por WhatsApp
- **Slice 07.3**: Confirmación de lectura (webhook WhatsApp Business)
- **Slice 07.4**: Envío por Email como alternativa
