# Especificación Slice 07.3: Historial y Estado de Envíos

## Objetivo
Permitir al médico visualizar en el `ConsultationManager` si una receta ya ha sido enviada por WhatsApp o Email, y cuándo fue el último envío.

## Alcance
- Backend: Modificar modelo `PrescriptionVerification` y endpoints.
- Frontend: Indicadores visuales en la lista de consultas.

## 1. Modelo de Datos (Backend)

Modificar **`backend/models.py`**, clase `PrescriptionVerification`.
Se agregan columnas específicas para rastrear el estado de cada canal. Se opta por columnas explícitas en lugar de JSON para facilitar consultas simples y compatibilidad directa con ORM.

```python
# Nuevas Columnas
email_sent_at = Column(DateTime, nullable=True)     # Último envío por email
whatsapp_sent_at = Column(DateTime, nullable=True)  # Último envío por WhatsApp
```
*Nota: La existencia de fecha implica que fue enviado. Si es `NULL`, no se envió.*

## 2. API Endpoints

### 2.1 Actualización de Envíos

**Email:**
El endpoint existente `POST /api/consultas/{id}/send-email` debe actualizar `email_sent_at` a `datetime.utcnow()` al completar el envío exitosamente (o al encolarlo).

**WhatsApp:**
Se requiere un nuevo endpoint (o modificar `create-verification`) para registrar el intento de envío.
Para mantener `create-verification` puro, crearemos:
`POST /api/consultas/{id}/mark-whatsapp-sent`
- **Auth**: Requerida.
- **Acción**: Busca/Crea `PrescriptionVerification` y actualiza `whatsapp_sent_at`.
- **Retorno**: `{ success: true, timestamp: ... }`

### 2.2 Consulta de Estado

`GET /api/consultas/{id}/dispatch-status`
- **Auth**: Requerida.
- **Retorno**:
```json
{
  "email_sent_at": "2026-01-05T10:00:00Z",
  "whatsapp_sent_at": null,
  "consultation_id": 123
}
```

*Nota*: Para optimizar, analizaremos si incluir esto en el listado principal, pero para mantener el slice pequeño, el fetch bajo demanda o en un segundo paso es aceptable.

## 3. Frontend (ConsultationManager)

### 3.1 Interfaz
- En la tarjeta de la consulta (historial), junto a los botones de Whatsapp/Email:
  - Mostrar un "badge" o icono de "check" si tiene fecha de envío.
  - Tooltip: "Enviado el {fecha}".
- Actualizar el estado local cuando se envía un email o se hace clic en WhatsApp.

### 3.2 Lógica
- `handleSendEmail`: Al éxito, llamar a `dispatch-status` para refrescar o actualizar localmente.
- `handleSendWhatsApp`: Al hacer clic, llamar a `mark-whatsapp-sent` y actualizar estado.
- `useEffect`: Cargar estado de envíos para las consultas visibles? O mejor, hacer que el endpoint de historial ya traiga esa info si es posible. Si no, fetch lazy.

## 4. Plan de Implementación (Automation FOCUSED)

### Fase C: Generación de Scripts
Dado que no se permite edición manual, generaremos scripts de PowerShell (`.ps1`) que:
1. Usen `alembic` (si hay) o SQL raw, o simplemente Python script con SQLAlchemy para migrar la DB (Models update + update schema).
2. Usen `PowerShell` para inyectar código en `models.py`, `schemas.py`, `api/consultations.py`.

## 5. Tests
- Verificar que `email_sent_at` se actualiza.
- Verificar que `mark-whatsapp-sent` actualiza.
- Verificar que el historial devuelve los datos correctos.
