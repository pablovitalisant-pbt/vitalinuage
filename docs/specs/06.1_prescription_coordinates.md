# Especificación de Contrato: Mapas de Coordenadas para Recetas (Slice 06.1)

Este documento define la estructura de datos y los contratos de API para el sistema de "Mapas de Coordenadas", permitiendo a los médicos ajustar la impresión de recetas a sus hojas pre-impresas.

## 1. Concepto
Un `PrescriptionMap` actúa como una capa de configuración sobre un PDF en blanco (o con fondo). Define dónde debe imprimirse cada dato (Paciente, Medicamentos, Fecha) en milímetros exactos.

## 2. Backend Contract (Pydantic)
Ubicación: `backend/schemas/prescription_map.py`

```python
from pydantic import BaseModel, Field
from typing import List, Optional

class FieldConfig(BaseModel):
    field_key: str = Field(..., description="Clave interna del dato (ej: patient_name, diagnosis)")
    x_mm: float = Field(..., description="Posición X desde la izquierda en mm")
    y_mm: float = Field(..., description="Posición Y desde arriba en mm")
    font_size_pt: int = Field(10, description="Tamaño de fuente en puntos")
    max_width_mm: Optional[float] = Field(None, description="Ancho máximo antes de salto de línea o recorte")

class PrescriptionMapBase(BaseModel):
    name: str = Field(..., description="Nombre amigable del mapa (ej: Recetario Personal)")
    canvas_width_mm: float = Field(148.0, description="Ancho del papel (A5=148mm)")
    canvas_height_mm: float = Field(210.0, description="Alto del papel (A5=210mm)")
    fields_config: List[FieldConfig] = Field(..., description="Configuración de cada campo")
    is_active: bool = Field(True, description="Si es el mapa por defecto del médico")

class PrescriptionMapCreate(PrescriptionMapBase):
    pass

class PrescriptionMapResponse(PrescriptionMapBase):
    id: int
    doctor_id: str
    background_image_url: Optional[str] = None # URL para previsualización (opcional)

    class Config:
        orm_mode = True
```

## 3. Frontend Contract (Zod)
Ubicación: `frontend/src/contracts/prescription_map.ts`

```typescript
import { z } from "zod";

export const FieldConfigSchema = z.object({
    field_key: z.string(),
    x_mm: z.number(),
    y_mm: z.number(),
    font_size_pt: z.number().default(10),
    max_width_mm: z.number().optional()
});

export const PrescriptionMapSchema = z.object({
    id: z.number().optional(),
    name: z.string().min(1, "Nombre requerido"),
    canvas_width_mm: z.number().positive(),
    canvas_height_mm: z.number().positive(),
    fields_config: z.array(FieldConfigSchema),
    is_active: z.boolean().default(true),
    background_image_url: z.string().optional()
});

export type PrescriptionMap = z.infer<typeof PrescriptionMapSchema>;
export type FieldConfig = z.infer<typeof FieldConfigSchema>;
```

## 4. API Endpoints
Prefijo: `/api/maps`

### `GET /current`
Obtiene el mapa activo del médico autenticado.
*   **Response:** `PrescriptionMapResponse`
*   **Error:** 404 si no tiene mapa configurado (Frontend debe usar defaults).

### `POST /`
Crea o actualiza el mapa del médico.
*   **Body:** `PrescriptionMapCreate`
*   **Behavior:** Si ya existe uno activo, lo actualiza o lo marca como inactivo (según regla de negocio, por ahora asumimos 1 mapa por médico para simplicidad).

## 5. Integración con PDFService
Cuando se llame a `/api/consultas/{id}/pdf`:
1.  El servicio busca el `PrescriptionMap` activo del médico.
2.  Si existe, usa las coordenadas `x_mm` / `y_mm` para posicionar texto usando coordenadas absolutas (en WeasyPrint o ReportLab).
3.  Si NO existe, usa el Template HTML por defecto (Minimal/Modern/Classic) definido en `pdf_templates.py`.

## 6. Próximos Pasos (Slice 06.1)
1.  Implementar esquemas Pydantic (`backend/schemas/prescription_map.py`).
2.  Implementar contrato Zod (`frontend/src/contracts/prescription_map.ts`).
3.  Implementar Modelo DB y APICRUD (Fase C).
