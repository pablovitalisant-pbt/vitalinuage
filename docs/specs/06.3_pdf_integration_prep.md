# Preparación para Slice 06.3: Integración PDF con Coordenadas

## Contexto
Los Slices 06.1 y 06.2 han establecido la infraestructura completa para el sistema de mapas de coordenadas:
- **Backend (06.1)**: API `/api/maps` que persiste configuraciones de coordenadas en formato JSON
- **Frontend (06.2)**: Editor visual drag-and-drop accesible en `/settings/talonario`

## Objetivo del Slice 06.3
Integrar el sistema de coordenadas con el motor de generación de PDFs existente para que las recetas médicas se impriman con los campos posicionados exactamente donde el médico los configuró.

## Arquitectura de Integración

### 1. Flujo de Datos
```
Usuario configura mapa → PrescriptionMapEditor
                              ↓
                        POST /api/maps
                              ↓
                    DB: prescription_maps
                              ↓
                    GET /api/maps/current
                              ↓
                        PDFService (Backend)
                              ↓
                    Genera PDF con coordenadas
```

### 2. Contrato de Datos (Ya Definido)
```python
# backend/schemas/prescription_map.py
class FieldConfig(BaseModel):
    field_key: str          # 'patient_name', 'diagnosis', etc.
    x_mm: float            # Posición X desde la izquierda
    y_mm: float            # Posición Y desde arriba
    font_size_pt: int      # Tamaño de fuente
    max_width_mm: float    # Ancho máximo del campo

class PrescriptionMapResponse(BaseModel):
    id: int
    name: str
    canvas_width_mm: float   # 148mm (A5)
    canvas_height_mm: float  # 210mm (A5)
    fields_config: List[FieldConfig]
    is_active: bool
```

### 3. Modificaciones Requeridas en PDFService

#### A. Cargar Configuración Activa
```python
# backend/services/pdf_service.py (nuevo método)
def get_active_prescription_map(doctor_email: str, db: Session) -> Optional[PrescriptionMap]:
    """
    Obtiene el mapa de coordenadas activo del médico.
    Si no existe, retorna None (usar layout por defecto).
    """
    return db.query(models.PrescriptionMap).filter(
        models.PrescriptionMap.doctor_id == doctor_email,
        models.PrescriptionMap.is_active == True
    ).first()
```

#### B. Convertir mm a Puntos PDF
```python
def mm_to_points(mm: float) -> float:
    """
    Convierte milímetros a puntos PDF (1mm = 2.83465 points)
    """
    return mm * 2.83465
```

#### C. Aplicar Coordenadas al Renderizado
```python
# Pseudocódigo de integración con WeasyPrint/ReportLab
def render_prescription_with_map(
    consultation_data: dict,
    prescription_map: PrescriptionMap
) -> bytes:
    """
    Genera PDF usando las coordenadas del mapa.
    """
    # 1. Crear canvas PDF (A5: 148mm x 210mm)
    canvas = create_pdf_canvas(
        width_mm=prescription_map.canvas_width_mm,
        height_mm=prescription_map.canvas_height_mm
    )
    
    # 2. Si hay background_image_url, renderizarlo primero
    if prescription_map.background_image_url:
        canvas.draw_background_image(prescription_map.background_image_url)
    
    # 3. Iterar sobre fields_config y posicionar cada campo
    for field in prescription_map.fields_config:
        # Mapear field_key a datos reales
        field_value = get_field_value(consultation_data, field.field_key)
        
        # Convertir coordenadas mm → puntos
        x_pt = mm_to_points(field.x_mm)
        y_pt = mm_to_points(field.y_mm)
        
        # Renderizar texto en la posición exacta
        canvas.draw_text(
            text=field_value,
            x=x_pt,
            y=y_pt,
            font_size=field.font_size_pt,
            max_width=mm_to_points(field.max_width_mm)
        )
    
    return canvas.to_pdf_bytes()
```

#### D. Mapeo de field_key a Datos
```python
FIELD_MAPPING = {
    'patient_name': lambda c: f"{c.patient.nombre} {c.patient.apellido_paterno}",
    'patient_dni': lambda c: c.patient.dni,
    'date': lambda c: c.fecha_consulta.strftime('%d/%m/%Y'),
    'diagnosis': lambda c: c.diagnostico,
    'treatment': lambda c: c.tratamiento,
    'doctor_signature': lambda c: "Firma y Sello Médico"
}

def get_field_value(consultation_data, field_key: str) -> str:
    """
    Extrae el valor del campo desde los datos de la consulta.
    """
    mapper = FIELD_MAPPING.get(field_key)
    if mapper:
        return mapper(consultation_data)
    return ""
```

### 4. Endpoint de Impresión Actualizado
```python
# backend/api/print.py (modificar endpoint existente)
@router.get("/mapped/{consultation_id}")
async def print_mapped_prescription(
    consultation_id: int,
    map_id: Optional[int] = None,  # Opcional: usar mapa específico
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    # 1. Obtener consulta
    consultation = db.query(models.ClinicalConsultation).filter(
        models.ClinicalConsultation.id == consultation_id,
        models.ClinicalConsultation.doctor_id == current_user.email
    ).first()
    
    if not consultation:
        raise HTTPException(404, "Consultation not found")
    
    # 2. Obtener mapa (específico o activo)
    if map_id:
        pmap = db.query(models.PrescriptionMap).filter(
            models.PrescriptionMap.id == map_id,
            models.PrescriptionMap.doctor_id == current_user.email
        ).first()
    else:
        pmap = get_active_prescription_map(current_user.email, db)
    
    # 3. Generar PDF
    if pmap:
        pdf_bytes = render_prescription_with_map(consultation, pmap)
    else:
        # Fallback: usar layout por defecto
        pdf_bytes = render_prescription_default(consultation)
    
    return Response(
        content=pdf_bytes,
        media_type="application/pdf",
        headers={"Content-Disposition": f"inline; filename=receta_{consultation_id}.pdf"}
    )
```

### 5. Feature Flag Check
```python
# Verificar que prescription_coords_v1 esté habilitado
def check_coords_feature_enabled() -> bool:
    with open('config/feature-flags.json') as f:
        flags = json.load(f)
    return flags.get('prescription_coords_v1', False)
```

## Criterios de Aceptación (Slice 06.3)

### Tests de Integración
1. **Test: PDF con mapa personalizado**
   - Crear mapa con coordenadas específicas
   - Generar PDF de consulta
   - Verificar que campos aparezcan en posiciones exactas

2. **Test: Fallback a layout por defecto**
   - Desactivar todos los mapas del médico
   - Generar PDF
   - Verificar que use template estándar

3. **Test: Feature flag OFF**
   - Deshabilitar `prescription_coords_v1`
   - Verificar que siempre use layout por defecto

### Smoke E2E
1. Usuario configura mapa en `/settings/talonario`
2. Guarda configuración
3. Va a perfil de paciente
4. Genera receta desde consulta
5. PDF descargado muestra campos en posiciones configuradas

## Estimación
- **Backend Integration**: 2 horas
- **Testing & Refinement**: 1 hora
- **Total**: 3 horas

## Próximos Pasos
1. Implementar `get_active_prescription_map()` en PDFService
2. Crear función `render_prescription_with_map()`
3. Actualizar endpoint `/api/print/mapped/{id}`
4. Escribir tests de integración
5. Verificación E2E manual
