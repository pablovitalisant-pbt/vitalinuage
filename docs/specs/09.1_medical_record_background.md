# Slice 09.1: Medical Record - Patient Background (Antecedentes)

## Objetivo
Implementar la gestión de **Antecedentes Médicos (Medical Background)** dentro de la Ficha Médica del paciente.
Este slice se centra en el **contrato de datos, API y UI** para visualizar y editar los antecedentes.

## Alcance
- **Backend**:
    - Nuevo modelo `MedicalBackground` (Relación 1:1 con `Patient`).
    - API Endpoints:
        - `GET /api/pacientes/{id}/antecedentes`
        - `PUT /api/pacientes/{id}/antecedentes`
- **Frontend**:
    - Nueva pestaña/sección "Antecedentes" en el Perfil del Paciente.
    - Formulario de edición de antecedentes.

## Contrato de Datos (DTOs)

### Modelo de Datos (Conceptual)
La entidad `MedicalBackground` almacenará información en formato JSONB o campos de texto estructurados. Para la versión inicial, usaremos campos de texto para flexibilidad, o JSONB si soportamos tags.
Dado el requerimiento de "reconstrucción", asumiremos una estructura clásica mapeada a campos de texto largo o arrays de strings.

**Campos propuestos:**
- `patient_id` (FK)
- `patologicos` (Text/JSON)
- `no_patologicos` (Text/JSON)
- `heredofamiliares` (Text/JSON)
- `quirurgicos` (Text/JSON)
- `alergias` (Text/JSON)
- `medicamentos_actuales` (Text/JSON)
- `files` (JSON - Referencias a archivos adjuntos, fuera de alcance MVP inicial pero considerado)

### Schemas (Pydantic)

```python
class MedicalBackgroundBase(BaseModel):
    patologicos: Optional[str] = None
    no_patologicos: Optional[str] = None
    heredofamiliares: Optional[str] = None
    quirurgicos: Optional[str] = None
    alergias: Optional[str] = None
    medicamentos_actuales: Optional[str] = None

class MedicalBackgroundCreate(MedicalBackgroundBase):
    pass

class MedicalBackground(MedicalBackgroundBase):
    id: int
    patient_id: int
    updated_at: datetime

    class Config:
        orm_mode = True
```

## API Endpoints

### 1. Obtener Antecedentes
`GET /api/pacientes/{patient_id}/antecedentes`

**Response:**
- `200 OK`: Objeto `MedicalBackground`. Si no existe, retorna objeto vacío o crea uno por defecto (lazy creation) o 404 (dependiendo de preferencia UX). Preferimos **objeto vacío con 200 OK** para facilitar edición.
- `404 Not Found`: Si el paciente no existe.

### 2. Actualizar/Guardar Antecedentes
`PUT /api/pacientes/{patient_id}/antecedentes`

**Body:**
`MedicalBackgroundCreate`

**Response:**
- `200 OK`: Objeto actualizado `MedicalBackground`.

## UI/UX (Frontend)

### Ubicación
En `/pacientes/{id}`, agregar una navegación interna (Tabs):
1. **Resumen** (Actual Dashboard del Paciente)
2. **Antecedentes** (Nuevo)
3. **Consultas** (Futuro)
4. **Recetas** (Futuro)

### Vista Antecedentes
- Layout de tarjetas o secciones acordeones.
- Botón "Editar" que transforma los textos en `Textarea`.
- Validación simple (campos opcionales).

## Plan de Pruebas (Verification)
1. **Test de Integración (Backend)**:
    - Crear paciente.
    - `GET` antecedentes (debe ser empty/null o default).
    - `PUT` antecedentes con datos.
    - `GET` antecedentes y verificar persistencia.
    - Validar aislamiento de tenants (crear antecedentes con Owner A, intentar leer con Owner B).

2. **Test E2E (Frontend)**:
    - Navegar a perfil.
    - Clic en tab "Antecedentes".
    - Llenar formulario y guardar.
    - Recargar página y verificar datos.

## Riesgos y Mitigaciones
- **Migración de Datos**: Si existen datos previos en Bubble/JSON, asegurar que el formato de texto/JSON sea compatible.
    - *Mitigación*: Usar campos de texto genéricos (`TEXT`) en Postgres inicialmente para máxima flexibilidad.
